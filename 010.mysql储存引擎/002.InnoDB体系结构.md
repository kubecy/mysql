#  InnoDB体系结构

## 1.内存结构（ In-Memory Structures）

![image-20241019150913466](./000.picture/image-20241019150913466.png)

### 1.1.Buffer Pool（缓冲池）

1. **概念**：
   - 缓冲池是主内存中的一个区域，里面可以缓存磁盘上经常操作的真实数据，主要用来缓冲或缓存数据库服务的数据页和索引页。在执行增删改查操作时，先操作缓冲池中的数据(若缓冲池没有数据，则从磁盘加载并缓存)，然后再以一定频率刷新到磁盘，从而减少磁盘10，加快处理速度。
   - 缓冲池以Page页为单位，底层采用链表数据结构管理Page。根据状态，将Page分为三种类型:
     - free page:空闲page，未被使用。
     - clean page:被使用page，数据没有被修改过。
     - dirty page:脏页，被使用page，数据被修改过，也中数据与磁盘的数据产生了不一致。

#### 1.1.1.Buffer Pool内存空间管理

~~~sql
-- 1、Buffer Pool配置参数信息查看，buffer pool默认内存空间大小为128M，生产建议大小可以设置为物理内存总量的50%~80%
mysql> select @@innodb_buffer_pool_size;
+---------------------------+
| @@innodb_buffer_pool_size |
+---------------------------+
|                 134217728 |
+---------------------------+

-- 2、InnoDB 存储引擎当前仅使用一个缓冲池实例。
mysql> select @@innodb_buffer_pool_instances;
+--------------------------------+
| @@innodb_buffer_pool_instances |
+--------------------------------+
|                              1 |
+--------------------------------+

-- 3、Buffer Pool配置参数修改方法
# 配置信息临时调整，配置调整后，重新登录mysql数据库生效
mysql > set global innodb_buffer_pool_size=268435456;

# 配置信息永久调整，配置调整后，重新启动mysql数据库生效
root@mysql-db111 /root # vim /etc/my.cnf
[mysqld]
innodb_buffer_pool_size=256M


mysql> show global status like '%innodb%wait%';
~~~

>:bell:优化。
>
>1. 产生不够用的情景有哪些？
>
>   - 设置太小。
>
>   - 大事务。
>
>   - ckpt触发不及时。
>
>   - IO比较慢。
>
>   - 查询语句优化的不好。
>
>2. 增加缓冲池实例的建议。
>
>   - 如果你的服务器有足够的内存，增加 `innodb_buffer_pool_instances` 的值可以帮助提高性能。通常推荐的做法是：
>
>     - 当 `innodb_buffer_pool_size` 大于 1GB 时，可以考虑设置多个实例。
>
>     - 缓冲池实例的数量可以设置为 `innodb_buffer_pool_size`（以MB为单位）除以 1GB。例如，若你的缓冲池为 8GB，建议设置为 8 个实例。
>
>       ~~~sql
>       innodb_buffer_pool_size = 8G      # 示例大小，根据实际情况调整
>       innodb_buffer_pool_instances = 8  # 根据实例数调整
>       ~~~

### 1.2.Change Buffer（更改缓冲区）

1. **概念**：
   - 更改缓冲区(针对于非聚集索引的插入、更新和删除操作)，在执行DML语句时，如果这些数据Page没有在Buffer Pool中，不会直接操作磁盘，而会将数据变更存在更改缓冲区 Change Buffer 中，在未来数据被读取时，再将数据合并恢复到BufferPool中，再将合并后的数据刷新到磁盘中。Change Buffer 提供了一种延迟写入的方式，减少了对磁盘的频繁访问。
   - 当对非聚集索引进行更改时，InnoDB 首先检查对应的索引页是否在缓冲池中，如果不在缓冲池中，相关更改会被记录在 Change Buffer 中。当该索引页被访问时，系统会将 Change Buffer 中的更改应用到该页上。
2. Change Buffer的意义是什么？
   - 与聚集索引不同，二级索引通常是非唯一的，并且以相对随机的顺序插入二级索引。同样，删除和更新可能会影响索引树中不相邻的二级索引页，如果每一次都操作磁盘，会造成大量的磁盘IO。有了ChangeBuffer之后，我们可以在缓冲池中进行合并处理，减少磁盘IO。

### 1.3.Adaptive Hash Index（自适应哈希）

1. **概念**：
   - 自适应hash索引，用于优化对Buffer Pool数据的查询。InnoDB存储引擎会监控对表上各索引页的查询，如果观察到hash索引可以提升速度，则建立hash索引，称之为自适应hash索引。它会动态地创建一个哈希索引，以加速对频繁访问的数据页的查询。
   - InnoDB 会监控对表的读操作，并根据访问模式自动生成哈希索引。当某个数据页被频繁访问时，InnoDB 会在内存中创建一个哈希表，该表将这些数据页的行指针映射到对应的哈希值。
   - 当查询到达时，系统可以使用哈希表直接查找，避免了全表扫描或多次 I/O 操作，从而加快了查询速度。

### 1.4.Log Buffer（日志缓冲区）

1. **概念**：
   - 日志缓冲区，用来保存要写入到磁盘中的l0g日志数据(redo log、undo log)，默认大小为 16MB，日志缓冲区的日志会定期刷新到磁盘中。如果需要更新、插入或删除许多行的事务，增加日志缓冲区的大小可以节省磁盘 I/O。
   - 当事务对数据进行修改时，相关的信息会被记录在日志缓冲区中，而不是立即写入磁盘的重做日志文件。日志缓冲区通常会在内存中以一定大小进行分配。
   - 在日志缓冲区满或达到一定条件时（如定时或事务提交），数据会被刷新到磁盘上的重做日志文件中。通过批量写入而不是逐条写入，可以显著降低磁盘 I/O 的开销，提高写入性能。

#### 1.4.1.Log Buffer管理

~~~sql
-- 1、日志缓冲区的大小、默认大小：16M、生产建议：和innodb_log_file_size有关，1-2倍
mysql> select @@innodb_log_buffer_size;

-- 修改
root@mysql-db111 /root # vim /etc/my.cnf
[mysqld]
innodb_log_file_size=2G      ## 重做日志文件的大小
innodb_log_files_in_group=3  ## 指定了 InnoDB 重做日志文件组中包含的日志文件数量为 3 个
innodb_log_buffer_size=1G    ## 设置日志缓冲区的大小为 1GB。

mysql> show global status like '%innodb%log%';
+------------------------------+-------+
| Variable_name                | Value |
+------------------------------+-------+
| Innodb_log_waits             | 0     |
| Innodb_log_write_requests    | 640   |
| Innodb_log_writes            | 11    |
| Innodb_os_log_fsyncs         | 9     |
| Innodb_os_log_pending_fsyncs | 0     |
| Innodb_os_log_pending_writes | 0     |
| Innodb_os_log_written        | 29184 |
| Innodb_redo_log_enabled      | ON    |
+------------------------------+-------+
~~~

## 2.磁盘结构（On-Disk Structures）

在磁盘存储结构中，会使用表空间模式进行数据信息的管理，经常提到的段 区 页概念也是属于表空间的逻辑结构；表空间的概念源于oracle数据库，最初的目的是为了能够更好的做存储的扩容；因此数据库的表空间技术类似磁盘管理的LVM技术。

### 2.1.Tables（表）





### 2.2.Indexes（索引）





### 2.3.Tablespaces（表空间）

#### 2.3.1.System Tablespace（系统表空间）

1. 概念：

   - 系统表空间是更改缓冲区的存储区域。是 InnoDB 存储引擎用于存储数据字典、表的元数据、索引以及其他系统级信息。
   - 如果表是在系统表空间而不是每个表文件或通用表空间中创建的，它也可能包含表和索引数据。(在MySQL5.x版本中还包含InnoDB数据字典、undolog等)
   - 可以通过配置参数 `innodb_data_file_path` 来设置系统表空间的路径和大小。需要注意的是，系统表空间的增长是自动的，但它不支持缩减，因此在设计时需要合理规划。

2. 数据库服务5.5版本时默认的表空间应用，具体数据存储数据方式为：ibdata1~ibdataN，ibdata共享表空间在各个版本之间的作用区别：

   >https://dev.mysql.com/doc/refman/5.7/en/innodb-architecture.html
   >
   >https://dev.mysql.com/doc/refman/8.0/en/innodb-architecture.html

   >对于InnoDB(8.0)表来讲，例如 city表
   >
   >city.ibd
   >
   >mysql.ibd
   >
   >undo
   >
   >ibdata
   >
   >redo

   | 数据库版本    | 存储数据     | 解释说明                                                     |
   | ------------- | ------------ | ------------------------------------------------------------ |
   | MySQL 5.5版本 | 系统相关数据 | 全局数据字典信息(表基本结构信息、状态系统参数、属性)、undo回滚日志(记录撤销操作);<br>Double write buffer信息、临时表信息、changer buffer |
   |               | 用户相关数据 | 业务表数据行、表的索引数据均统一存储在ibdata1中，实现集中管理<br>数据表中数据清理后，ibdata1也不会释放磁盘空间 |
   | MySQL 5.6版本 | 系统相关数据 | 全局数据字典信息(表基本结构信息、状态系统参数、属性)、undo回滚日志(记录撤销操作);<br/>Double write buffer信息、临时表信息、changer buffer |
   |               | 用户相关数据 | `共享表空间只存储系统数据，用户相关数据被独立管理了(独立表空间管理)` |
   | MySQL 5.7版本 | 系统相关数据 | 全局数据字典信息 undo回滚日志 Double write buffer信息、changer buffer<br>`临时表信息被独立出来了，undo也可以设定为独立` |
   |               | 用户相关数据 | 共享表空间只存储系统数据，用户相关数据被独立管理了(独立表空间管理) |
   | MySQL 8.0.11  | 系统相关数据 | Double write buffer信息、changer buffer<br>`undo回滚日志信息被独立出来了，数据字典信息也不再集中存储管理了` |
   |               | 用户相关数据 | 共享表空间只存储系统数据，用户相关数据被独立管理了(独立表空间管理) |
   | MySQL 8.0.20  | 系统相关数据 | changer buffer<br>`Double write buffer信息被独立出来了`      |

	##### 2.3.1.1.共享表空间管理

~~~sql
-- 1、共享表空间信息查看，可以在初始安装好数据库服务后，进行修改配置为两个ibdate文件，每个共享表空间文件占用2G，总共占用4个G空间
mysql> select @@innodb_data_file_path; 
+--------------------------+
| @@innodb_data_file_path  |
+--------------------------+
| ibdata1:2000M:autoextend |
+--------------------------+
1 row in set (0.00 sec)

-- 2、查看参数信息说明：ibdata1文件，默认初始大小12M，不够用会自动扩展，默认每次扩展64M
mysql> select @@innodb_autoextend_increment;
+-------------------------------+
| @@innodb_autoextend_increment |
+-------------------------------+
|                            64 |
+-------------------------------+


-- 3、共享表空间的扩容操作方法、配置文件设定为和实际大小一致
root@mysql-db111 /app/mysql/data # ll ibdata1 -h
-rw-r----- 1 mysql mysql 2.0G Oct 20 00:20 ibdata1

## 编写数据库配置文件信息，需要注意的是ibdata1文件大小必须和实际数据库要存储的数据相匹配，否则会出现如下报错信息
vim /etc/my.cnf
[mysqld]
innodb_data_file_path=ibdata1:12M;ibdata2:100M;ibdata3:100M:autoextend

#########
 [ERROR] [MY-012264] [InnoDB] The innodb_system data file './ibdata1' is of a different size 768 pages (rounded down to MB) than the 4864 pages specified in the .cnf file!
-- 表示ibdate1指定大小超过了原有ibdata1实际的大小尺寸
#########

# 查看配置信息是否生效
mysql> select @@innodb_data_file_path;
+---------------------------------------------------------------------+
| @@innodb_data_file_path                                             |
+---------------------------------------------------------------------+
| ibdata1:12M;/data02/ibdata2:100M;/data03/ibdata3:100M:autoextend    |
+---------------------------------------------------------------------+

配置文件设定为和实际大小一致：
innodb_data_file_path=ibdata1:76M;ibdata2:100M;ibdata3:100M:autoextend
### 模拟在初始化时设置共享表空间（生产建议）
5.7 中建议：设置共享表空间2-3个，大小建议512M或者1G，最后一个定制为自动扩展。
8.0 中建议：设置1-2个就ok，大小建议512M或者1G
~~~

##### 2.3.1.2.共享表空间的初始设置方法

~~~sql
# 模拟初始化清理数据
root@mysql-db111 /root # /etc/init.d/mysqld stop
root@mysql-db111 /root # rm -rf /data/3306/data/*

# 模拟初始化配置文件
root@mysql-db111 /root # vim /etc/my.cnf
[mysqld]
innodb_data_file_path=ibdata1:100M;ibdata2:100M;ibdata3:100M:autoextend

# 模拟初始化操作命令
root@mysql-db111 /root # mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/data/3306/data

# 模拟初始化重启服务
root@mysql-db111 /root #  /etc/init.d/mysqld start
~~~

#### 2.3.2.File-Per-Table Tablespaces（独立表空间）

1. 概念：
   - 允许每个 InnoDB 表使用独立的文件来存储数据和索引。这种模式使得每个表都有自己的表空间文件，而不是将所有表的数据存储在一个共享的系统表空间中。
2. 独立表空间在各个版本之间的作用区别
   - 在数据库服务8.0版本前：
     - 用户表包含三个部分组成（表.ibd 表.frm ibdata1-全局数据字典信息存储）；
     - 所以在8.0之前，如果想修改表数据结构信息(元数据修改)，都会修改frm和ibdata文件信息，每次更新都会锁表(元数据锁)；
     - 因为要保证数据一致性，并且两个表均更新完，才能释放解锁，因此在8.0前修改元数据信息，要避开业务繁忙时间段；
   - 在数据库服务8.0版本后
     - 用户表数据进行统一存储（表.ibd）; 如果想修改表数据结构信息(元数据修改)，只会修改ibd文件信息；
     - 此时不需要对两个表文件均更新，只要更新一个文件即可，因此对文件锁的代价降低了，降低了对业务的影响；

##### 2.3.2.1.独立表空间管理

~~~sql
-- 1、表空间配置参数信息查看，每个表就是一个独立文件，进行数据信息的独立存储，不建议进行修改，如果改为0就是所有数据统一存储在共享表空间
mysql> select @@innodb_file_per_table;
+-------------------------+
| @@innodb_file_per_table |
+-------------------------+
|                       1 |
+-------------------------+

root@mysql-db111 /root #  ibd2sdi city.ibd
-- 可以看到文件中存储的元数据信息(数据字典信息)，并且数据库8.0之后不再有表对应的frm文件信息了
-- 在数据库5.7环境中，每个表数据信息会存储生成两个表 frm ibd
-- frm文件中存储数据表的数据字典信息(元数据信息)
-- ibd文件中存储数据行信息和索引信息


-- 2、表空间配置参数信息修改，设置为0表示利用共享表空间存储用户数据 1表示利用独立表空间存储用户数据
mysql > set global innodb_file_per_table=0
~~~

#### 2.3.3.GeneralTablespaces（通用表空间）

1. 概念：
   - 通用表空间是 InnoDB 存储引擎的一种新特性，允许用户创建共享的表空间，以便多个 InnoDB 表可以存储在同一个表空间文件中。这种模式与系统表空间和独立表空间相区别，提供了灵活的管理选项。
2. 创建和管理
   - 使用 SQL 语句 `CREATE TABLESPACE` 可以创建通用表空间。
   - 通过 `ALTER TABLE` 语句将现有表移动到通用表空间中。

#### 2.3.4.Undo Tablespaces（撤销表空间）

1. 概念：
   - 撤销表空间，MySQL实例在初始化时会自动创建两个默认的undo表空间(初始大小16M)，用于存储undolog日志。撤销日志用于实现事务的回滚和多版本并发控制（MVCC），记录数据修改前的状态。
   - 在数据库5.7版本中，默认存储在共享表空间中（ibdata）；在数据库8.0版本后，默认就是独立存储了(undo_001-undo_002)；
   - 在实际生产环境中，建议在5.7版本之后，都将undo表空间进行独立文件存储

##### 2.3.4.1.undo表空间管理

~~~sql
-- 1、表空间配置参数信息查看，确认是否打开独立undo模式，并设置undo表空间文件个数（3-5个）
mysql> select @@innodb_undo_tablespaces;
+---------------------------+
| @@innodb_undo_tablespaces |
+---------------------------+
|                         2 |
+---------------------------+

-- 2、表示undo日志信息的大小，默认1G
mysql> select @@innodb_max_undo_log_size;
+----------------------------+
| @@innodb_max_undo_log_size |
+----------------------------+
|                 1073741824 |
+----------------------------+

-- 3、表示开启undo自动回收的机制（undo purge）
mysql> select @@innodb_undo_log_truncate;
+----------------------------+
| @@innodb_undo_log_truncate |
+----------------------------+
|                          1 |
+----------------------------+

-- 3、触发自动回收的条件，单位是检测次数 
mysql> select @@innodb_purge_rseg_truncate_frequency;
+----------------------------------------+
| @@innodb_purge_rseg_truncate_frequency |
+----------------------------------------+
|                                    128 |
+----------------------------------------+
~~~

>:bell:undo表空间的数量只能在初始化MySQL实例时配置，并且在实例生命周期内是固定的

~~~sql
-- 1、表空间配置参数修改调整，修改数据库5.7版本服务的undo表空间，实现undo表空间的独立存储；

mysql> select @@innodb_undo_tablespaces;
+---------------------------+
| @@innodb_undo_tablespaces |
+---------------------------+
|                         2 |
+---------------------------+

-- 2、关闭数据库服务程序，对undo表空间进行独立存储配置

# 关闭数据库服务程序，清理数据库服务数据目录
root@mysql-db111 /root # systemctl stop mysqld
root@mysql-db111 /root # rm -rf /app/mysqldata/*

# 编写修改数据库服务配置文件
root@mysql-db111 /root # vim /etc/my.cnf
[mysqld]
innodb_undo_tablespaces=3
innodb_max_undo_log_size=128M
innodb_undo_log_truncate=ON
innodb_purge_rseg_truncate_frequency=32

##  在数据库服务端添加以上参数信息

-- 3、重新初始化数据库服务程序
root@mysql-db111 /root # /usr/local/mysql57/bin/mysqld --defaults-file=/data/3357/my.cnf --initialize-insecure  --basedir=/usr/local/mysql57 --datadir=/app/mysql/data --user=mysql

root@mysql-db111 /root # ll /data/3357/data/undo*
-rw-r----- 1 mysql mysql 10485760 11月 15 10:19 /data/3357/data/undo001
-rw-r----- 1 mysql mysql 10485760 11月 15 10:19 /data/3357/data/undo002
-rw-r----- 1 mysql mysql 10485760 11月 15 10:19 /data/3357/data/undo003

-- 4、重新启动数据库服务程序
root@mysql-db111 /root # systemctl restart mysqld
~~~

>说明：对于数据库8.0版本，在进行undo表空间配置信息调整的时候，可以进行在线调整；
>
>数据库8.0 undo表空间与数据库5.7undo表空间区别资料：
>
>- https://dev.mysql.com/doc/refman/8.0/en/innodb-undo-tablespaces.html

~~~sql
-- 1、实现undo表空间文件指定目录存储
# 将数据库服务进行关闭
root@mysql-db111 /root # systemctl stop mysqld

# 编写数据库服务配置文件
root@mysql-db111 /root # vim /etc/my.cnf
[mysqld]
innodb_undo_directory=/app/mysql/data/undologs

# 创建存储undo表空间文件目录
root@mysql-db111 /root # mkdir -p /app/mysql/data/undologs && chown -R mysql.mysql /app/mysql/data/undologs

# 将数据库服务进行启动
root@mysql-db111 /root # systemctl restart mysqld

-- 2、查看
mysql > select @@innodb_undo_directory;
~~~

~~~sql
-- 1、创建新的独立的undo表空间文件
CREATE UNDO TABLESPACE tablespace_name ADD DATAFILE 'file_name.ibu';

-- 2、查看已经创建的独立的undo表空间文件
mysql> select tablespace_name,file_name from information_schema.files where file_type like 'undo log';
+---------------------------+----------------+
| TABLESPACE_NAME    | FILE_NAME    |
+---------------------------+----------------+
| innodb_undo_001    | ./undo_001   |
| innodb_undo_002    | ./undo_002   |
| tablespace_name    | ./mmban1.ibu |
+---------------------------+----------------+

-- 3、将指定的undo表空间信息设置为失效
ALTER UNDO TABLESPACE tablespace_name SET INACTIVE;

-- 4、删除已有的独立的undo表空间文件
DROP UNDO TABLESPACE tablespace_name;

-- 5、查看已有的独立的undo表空间状态
SELECT NAME, STATE FROM INFORMATION_SCHEMA.INNODB_TABLESPACES
  WHERE NAME LIKE 'tablespace_name';
~~~

#### 2.3.5.Temporary Tablespaces（临时表空间）

1. 概念：
   - 临时表空间是 InnoDB 存储引擎专门用于存储临时表和临时数据的表空间。
   - 临时表空间主要用于存储临时表信息，主要是在使用group by，order by，having，unique all，子查询等情况都会使用临时表；
   - 临时表可以存储在内存和磁盘上；
2. 使用场景：
   - **复杂查询**：在执行需要多个步骤或中间结果的复杂查询时，临时表用于存储这些中间结果。
   - **排序和分组操作**：当查询涉及大量数据的排序和分组操作时，使用临时表可以有效管理这些中间数据。

##### 2.3.5.1.临时表空间管理

~~~sql
-- 1、扩容前临时表空间信息查看
mysql> select @@innodb_temp_data_file_path;
+------------------------------+
| @@innodb_temp_data_file_path |
+------------------------------+
| ibtmp1:12M:autoextend        |
+------------------------------+

-- 2、查看参数信息说明：ibtmp1文件，默认初始大小12M，不够用会自动扩展，默认每次扩展64M
mysql> select @@innodb_autoextend_increment;
+-------------------------------+
| @@innodb_autoextend_increment |
+-------------------------------+
|                            64 |
+-------------------------------+

-- 3、临时表空间的扩容操作方法
# 编写数据库配置文件信息，需要注意的是ibdata1文件大小必须和实际数据库要存储的数据相匹配，否则会出现如下报错信息
vim /etc/my.cnf
[mysqld]
innodb_temp_data_file_path=ibtmp1:12M;ibtmp2:120M:autoextend:max:500M

# 查看配置信息是否生效
mysql> select @@innodb_temp_data_file_path;
+---------------------------------------------------------------------+
| @@innodb_temp_data_file_path                                        |
+---------------------------------------------------------------------+
| ibtmp1:12M;ibtmp2:120M:autoextend:max:500M                          |
+---------------------------------------------------------------------+
~~~

>说明：建议数据初始化之前设定好临时表空间，建议2~3个，大小512M~1G；

| 序号 | 版本信息  | 建议说明                                                     |
| ---- | --------- | ------------------------------------------------------------ |
| 01   | MySQL 5.7 | 设置共享表空间2~3个，大小建议512M或1G，最后一个定制为自动扩展 |
| 02   | MySQL 8.0 | 设置共享表空间1个即可，大小建议512M或1G                      |

~~~sql
-- 1、临时表空间的初始设置方法
# 关闭数据库服务程序，清理数据库服务数据目录
root@mysql-db111 /root # systemctl stop mysqld
root@mysql-db111 /root # rm -rf /app/mysqldata/*

# 模拟初始化配置文件
root@mysql-db111 /root # vim /etc/my.cnf
[mysqld]
innodb_temp_data_file_path=ibtmp1:12M;ibtmp2:120M:autoextend:max:500M

# 模拟初始化操作命令
root@mysql-db111 /root # mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/app/mysql/data

root@mysql-db111 /root # systemctl restart mysqld
~~~

### 2.4.Doublewrite Buffer（双写缓冲区）





### 2.5.Redo Log（重做日志）





### 2.6.Undo Logs（撤销日志）

