# 事务基础

## 1.事务简介

>事务是指在数据库管理系统中，一系列操作被视为一个单独的、不可分割的工作单元。事务会把所有的操作作为一个整体一起向系
>
>统提交或撤销操作请求。这些操作要么全部成功执行，要么全部不执行，从而保证数据的一致性和完整性。

就比如: 张三给李四转账1000块钱，张三银行账户的钱减少1000，而李四银行账户的钱要增加1000。 这一组操作就必须在一个事务的范围内，要么都成功，要么都失败。

![image-20241019103405260](./000.picture/image-20241019103405260.png)

正常情况: 转账这个操作, 需要分为以下这么三步来完成 , 三步完成之后, 张三减少1000, 而李四增加1000, 转账成功 。

异常情况: 转账这个操作, 也是分为以下这么三步来完成 , 在执行第三步是报错了, 这样就导致张三减少1000块钱, 而李四的金额没变, 这样就造成了数据的不一致, 就出现问题了。

为了解决上述的问题，就需要通过数据的事务来完成，我们只需要在业务逻辑执行之前开启事务，执行完毕后提交事务。如果执行过程中报错，则回滚事务，把数据恢复到事务开始之前的状态。

![image-20241019103529610](./000.picture/image-20241019103529610.png)

>:bell:默认MySQL的事务是自动提交的，也就是说，当执行完一条DML语句时，MySQL会立即隐式的提交事务。

## 2.事务操作

1. 数据准备。

~~~sql
mysql> create  database  test_db;
Query OK, 1 row affected (0.00 sec)

mysql> use test_db;
Database changed
mysql> 
mysql> create table account(
    -> id int primary key AUTO_INCREMENT comment 'ID',
    -> name varchar(10) comment '姓名',
    -> money double(10,2) comment '余额'
    -> ) comment '账户表';
Query OK, 0 rows affected, 1 warning (0.03 sec)

mysql> 
mysql> insert into account(name, money) VALUES ('张三',2000), ('李四',2000);
~~~

### 2.1.未控制事务，

1. 测试正常数据。

~~~sql
-- 1. 查询张三余额
mysql> select * from account where name = '张三';
+----+--------+---------+
| id | name   | money   |
+----+--------+---------+
|  1 | 张三   | 2000.00 |
+----+--------+---------+
1 row in set (0.00 sec)

-- 2. 张三的余额减少1000
mysql> update account set money = money - 1000 where name = '张三';

-- 3. 李四的余额增加1000
mysql> update account set money = money + 1000 where name = '李四';

mysql> select * from account;
+----+--------+---------+
| id | name   | money   |
+----+--------+---------+
|  1 | 张三   | 1000.00 |
|  2 | 李四   | 3000.00 |
+----+--------+---------+
2 rows in set (0.00 sec)
~~~

2. 测试异常情况。

~~~sql
-- 1. 查询张三余额
select * from account where name = '张三';

-- 2. 张三的余额减少1000
update account set money = money - 1000 where name = '张三';
出错了....

-- 3. 李四的余额增加1000
update account set money = money + 1000 where name = '李四';
~~~

### 2.1.控制事务

1. 查看/设置事务提交方式

~~~sql
mysql> SELECT @@autocommit ;
+--------------+
| @@autocommit |
+--------------+
|            1 |
+--------------+
1 row in set (0.00 sec)

mysql> SET @@autocommit = 0 ;
Query OK, 0 rows affected (0.00 sec)

mysql> SELECT @@autocommit ;
+--------------+
| @@autocommit |
+--------------+
|            0 |
+--------------+
1 row in set (0.00 sec)

mysql> COMMIT;
Query OK, 0 rows affected (0.00 sec)

mysql> ROLLBACK;
Query OK, 0 rows affected (0.00 sec)
~~~

>:bell:上述的这种方式，我们是修改了事务的自动提交行为, 把默认的自动提交修改为了手动提交, 此时我们执行的DML语句都不会提交, 需要手动的执行commit进行提交。

~~~sql
START TRANSACTION 或 BEGIN ;

-- 1. 开启事务
mysql> BEGIN ;
Query OK, 0 rows affected (0.00 sec)

-- 2. 提交事务
mysql> COMMIT;
Query OK, 0 rows affected (0.00 sec)

-- 3. 回滚事务
mysql> ROLLBACK;
Query OK, 0 rows affected (0.00 sec)
~~~

2. 案例

~~~sql
-- 开启事务
start transaction

-- 1. 查询张三余额
select * from account where name = '张三';

-- 2. 张三的余额减少1000
update account set money = money - 1000 where name = '张三';

-- 3. 李四的余额增加1000
update account set money = money + 1000 where name = '李四';

-- 如果正常执行完毕, 则提交事务
commit;

-- 如果执行过程中报错, 则回滚事务
-- rollback;
~~~



